define(["jquery","core/yui","core/str","core/log","core/ajax","core/event","editor_marklar/filepicker","editor_marklar/imagepaster"],function(a,b,c,d,e,f,g,h){"use strict";function i(a,b){this.initparams=b,"undefined"!=typeof M.editor_marklar.fpoptions[b.elementid]&&(this.initparams.filepickeroptions=M.editor_marklar.fpoptions[b.elementid]),this.initTextArea(a),this.initFormatSelector(),this.initPanel(),this.initFilesEmbedding(),this.initPreview(),this.initSyntaxHelp(),this.initImagePaster()}return i.prototype.initTextArea=function(a){var b=this;b.textarea=a.addClass("marklar-textarea").css("box-sizing","border-box").css("width","100%").css("background-color","white").css("margin-bottom","10px").css("padding","7px")},i.prototype.initFormatSelector=function(){var b=this,e=b.textarea.attr("name").replace("[text]","[format]"),f=b.textarea.closest("form");if(e!==b.textarea.attr("name")&&(b.formatSelector=f.find('select[name="'+e+'"]'),!b.formatSelector.length)){var g,h,i=f.find('input[name="'+e+'"]');if(!i.length)return void d.error("marklar: format field not found: "+e);switch(g=parseInt(i.attr("value"))){case 0:h="formattext";break;case 1:h="formathtml";break;case 2:h="formatplain";break;case 4:h="formatmarkdown";break;default:return d.error("marklar: unknown text format "+g),void(b.formatSelector=null)}b.formatSelector=a('<select class="custom-select" name="'+e+'"></select>').append(a('<option value="'+g+'">'+h+"</option>")),i.remove(),c.get_string(h,"core_moodle").done(function(a){b.formatSelector.find('option[value="'+g+'"]').text(a)}).fail(function(a){d.error(a)})}},i.prototype.initPanel=function(){var b=this;b.textarea.wrap('<div class="marklar-wrapper"></div>'),b.panel=a('<div class="marklar-panel"></div>').insertAfter(b.textarea),b.editpanel=a('<div class="marklar-edit-panel"></div>').appendTo(b.panel),b.formatSelector&&(b.editpanel.append(b.formatSelector),b.formatSelector.attr("data-marklar-widget","format-select")),b.panel.prepend('<span data-marklar-placeholder="preview" />'),b.editpanel.append('<span data-marklar-placeholder="syntax" />'),b.editpanel.append('<span data-marklar-placeholder="insert-image" />'),b.editpanel.append('<span data-marklar-placeholder="insert-file" />')},i.prototype.initFilesEmbedding=function(){if(!("filepickeroptions"in this.initparams))return void d.error(this.initparams.elementid+": File picker options not found");var e=this;b.use("core_filepicker",function(){e.filepicker=g.init(e.initparams.filepickeroptions),e.filepicker.canShowFilepicker("image")&&c.get_string("insertimage","editor_marklar").done(function(b){var c=a('<button class="btn btn-default" data-marklar-widget="insert-image" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("image",function(a){e.imageEmbedded(a)})}),e.panel.find('[data-marklar-placeholder="insert-image"]').replaceWith(c),e.insertImageButton=c}),e.filepicker.canShowFilepicker("link")&&c.get_string("insertlink","editor_marklar").done(function(b){var c=a('<button class="btn btn-default" data-marklar-widget="insert-file" />');c.text(b),c.click(function(a){a.preventDefault(),e.filepicker.showFilepicker("link",function(a){e.insertLink(a)})}),e.panel.find('[data-marklar-placeholder="insert-file"]').replaceWith(c),e.insertFileButton=c})})},i.prototype.initPreview=function(){var b=this;return!!b.formatSelector&&(b.previewBody=a('<div class="marklar-preview" />').hide(),b.panel.before(b.previewBody),c.get_strings([{key:"previewon",component:"editor_marklar"},{key:"previewoff",component:"editor_marklar"}]).then(function(c){b.previewButtonOn=a('<button class="btn btn-default" data-marklar-widget="preview-on" />').text(c[0]).on("click",b.previewOn.bind(b)),b.previewButtonOff=a('<button class="btn btn-default" data-marklar-widget="preview-off" >').text(c[1]).on("click",b.previewOff.bind(b)).hide();var d=a('<div class="marklar-preview-controls" />').append(b.previewButtonOn).append(b.previewButtonOff);return b.panel.find('[data-marklar-placeholder="preview"]').replaceWith(d),!0}))},i.prototype.previewOn=function(a){var b=this;return a.preventDefault(),c.get_string("previewloading","editor_marklar").then(function(a){return b.previewButtonOn.hide(),b.previewButtonOff.show(),b.editpanel.hide(),b.previewBody.html('<div class="marklar-preview-loading">'+a+"</div>"),b.previewBody.height(b.textarea.height()),b.textarea.hide(),b.previewBody.show(),b.previewLoad(),!0})},i.prototype.previewOff=function(a){var b=this;a.preventDefault(),b.previewButtonOff.hide(),b.previewButtonOn.show(),b.editpanel.show(),b.previewBody.hide(),b.previewBody.html(""),b.textarea.show()},i.prototype.previewLoad=function(){var a=this,b={text:a.textarea.val(),format:a.formatSelector.val(),contextid:a.initparams.contextid};return e.call([{methodname:"editor_marklar_get_preview",args:b}])[0].fail(function(b){return a.previewBody.html('<div class="alert alert-error"><b>Error:</b> '+b.message+"</div>"),d.error(b),!1}).then(function(b){return a.previewBody.html(b.html),f.notifyFilterContentUpdated(a.previewBody),!0})},i.prototype.imageEmbedded=function(a){"url"in a&&this.insertText('<img alt="" class="img-responsive" src="'+a.url+'"/>')},i.prototype.insertLink=function(a){if("url"in a){var b;b="file"in a&&a.file?a.file.replace(/(\[|\])/g,"_"):"texttoshow",this.insertText("["+b+"]("+a.url+")")}},i.prototype.insertText=function(a){var b=this.textarea.val(),c=this.textarea.prop("selectionStart"),d=this.textarea.prop("selectionEnd");this.textarea.val(b.substring(0,c)+a+b.substring(d))},i.prototype.initSyntaxHelp=function(){var b=this;return!!b.formatSelector&&(b.syntaxBody=a('<div class="marklar-syntax-help" />').hide(),b.editpanel.append(b.syntaxBody),c.get_strings([{key:"syntaxon",component:"editor_marklar"},{key:"syntaxoff",component:"editor_marklar"}]).then(function(c){b.syntaxButtonOn=a('<button class="btn btn-link" data-marklar-widget="syntax-on" />').text(c[0]).on("click",b.syntaxOn.bind(b)),b.syntaxButtonOff=a('<button class="btn btn-link" data-marklar-widget="syntax-off" />').text(c[1]).on("click",b.syntaxOff.bind(b)).hide();var d=a('<div class="marklar-syntax-controls" />').append(b.syntaxButtonOn).append(b.syntaxButtonOff);return b.panel.find('[data-marklar-placeholder="syntax"]').replaceWith(d),!0})["catch"](function(a){return d.error(a),!1}),b.formatSelector&&b.formatSelector.on("change",function(){b.syntaxBody.is(":visible")&&b.syntaxButtonOn.click()}),!0)},i.prototype.initImagePaster=function(){var a=this;a.initparams.filepickeroptions.image&&h.init(a.textarea,a.initparams.filepickeroptions.image,a.imageEmbedded.bind(this))},i.prototype.syntaxOn=function(a){var b=this;return a.preventDefault(),c.get_string("syntaxloading","editor_marklar").then(function(a){return b.syntaxButtonOn.hide(),b.syntaxButtonOff.show(),b.syntaxBody.html('<div class="marklar-syntax-loading">'+a+"</div>"),b.syntaxBody.show(),b.syntaxLoad(),!0})},i.prototype.syntaxOff=function(a){var b=this;a.preventDefault(),b.syntaxButtonOff.hide(),b.syntaxButtonOn.show(),b.syntaxBody.hide(),b.syntaxBody.html("")},i.prototype.syntaxLoad=function(){var a=this;return c.get_string("syntax-format"+a.formatSelector.val(),"editor_marklar").then(function(b){a.syntaxBody.html(b)})},{init:function(b){var c;if(!("elementid"in b))throw new Error("editor_marklar: Invalid editor init parameter - missing elementid");if(c=a(document.getElementById(b.elementid)),c.length)return new i(c,b);throw new Error("Unable to find textarea element",b.elementid)}}});